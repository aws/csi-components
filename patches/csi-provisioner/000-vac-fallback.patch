From 1da98035fc8b58f19580d382cde084fffde25a45 Mon Sep 17 00:00:00 2001
From: Eddie Torres <torredil@amazon.com>
Date: Fri, 12 Dec 2025 14:56:24 +0000
Subject: [PATCH] Enable VAC Beta Fallback

Signed-off-by: Eddie Torres <torredil@amazon.com>
---
 cmd/csi-provisioner/csi-provisioner.go | 16 +++++++----
 pkg/controller/controller.go           |  8 +++---
 pkg/controller/vac_compat.go           | 40 ++++++++++++++++++++++++++
 3 files changed, 55 insertions(+), 9 deletions(-)
 create mode 100644 pkg/controller/vac_compat.go

diff --git a/cmd/csi-provisioner/csi-provisioner.go b/cmd/csi-provisioner/csi-provisioner.go
index 4cb07e693..74de87980 100644
--- a/cmd/csi-provisioner/csi-provisioner.go
+++ b/cmd/csi-provisioner/csi-provisioner.go
@@ -208,12 +208,18 @@ func main() {
 	}
 
 	if !utilfeature.DefaultMutableFeatureGate.ExplicitlySet(features.VolumeAttributesClass) {
-		volumeAttributesClassV1Enabled, err := features.IsVolumeAttributesClassV1Enabled(clientset.Discovery())
-		if err == nil && !volumeAttributesClassV1Enabled {
+		vacFallbackEnabled := os.Getenv("ENABLE_VAC_FALLBACK") == "true"
+		volumeAttributesClassV1Enabled, vacErr := features.IsVolumeAttributesClassV1Enabled(clientset.Discovery())
+		if vacErr == nil && !volumeAttributesClassV1Enabled {
 			if utilfeature.DefaultMutableFeatureGate.Enabled(features.VolumeAttributesClass) {
-				klog.InfoS("Disabling VolumeAttributesClass feature gate because the VolumeAttributesClass v1 API is not available")
-				if err := utilfeature.DefaultMutableFeatureGate.Set(fmt.Sprintf("%s=false", features.VolumeAttributesClass)); err != nil {
-					klog.Fatalf("Failed to disable VolumeAttributesClass feature gate: %v", err)
+				if vacFallbackEnabled {
+					klog.InfoS("VolumeAttributesClass v1 API not available, will use v1beta1 fallback")
+					ctrl.SetUseVACBetaAPI(true)
+				} else {
+					klog.InfoS("Disabling VolumeAttributesClass feature gate because the VolumeAttributesClass v1 API is not available")
+					if err := utilfeature.DefaultMutableFeatureGate.Set(fmt.Sprintf("%s=false", features.VolumeAttributesClass)); err != nil {
+						klog.Fatalf("Failed to disable VolumeAttributesClass feature gate: %v", err)
+					}
 				}
 			}
 		}
diff --git a/pkg/controller/controller.go b/pkg/controller/controller.go
index 280e08e6f..180bbae46 100644
--- a/pkg/controller/controller.go
+++ b/pkg/controller/controller.go
@@ -799,16 +799,16 @@ func (p *csiProvisioner) prepareProvision(ctx context.Context, claim *v1.Persist
 	}
 
 	if vacName != "" {
-		vac, err := p.client.StorageV1().VolumeAttributesClasses().Get(ctx, vacName, metav1.GetOptions{})
+		driverName, parameters, err := getVolumeAttributesClass(ctx, p.client, vacName)
 		if err != nil {
 			return nil, controller.ProvisioningNoChange, err
 		}
 
-		if vac.DriverName != p.driverName {
-			return nil, controller.ProvisioningFinished, fmt.Errorf("VAC %s referenced in PVC is for driver %s which does not match driver name %s", vacName, vac.DriverName, p.driverName)
+		if driverName != p.driverName {
+			return nil, controller.ProvisioningFinished, fmt.Errorf("VAC %s referenced in PVC is for driver %s which does not match driver name %s", vacName, driverName, p.driverName)
 		}
 
-		req.MutableParameters = vac.Parameters
+		req.MutableParameters = parameters
 	}
 
 	return &prepareProvisionResult{
diff --git a/pkg/controller/vac_compat.go b/pkg/controller/vac_compat.go
new file mode 100644
index 000000000..de0787ede
--- /dev/null
+++ b/pkg/controller/vac_compat.go
@@ -0,0 +1,40 @@
+package controller
+
+import (
+	"context"
+
+	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
+	"k8s.io/client-go/kubernetes"
+)
+
+var (
+	useVACBetaAPI bool
+)
+
+// SetUseVACBetaAPI sets whether to use the v1beta1 VAC API.
+// This is called during initialization based on API availability and ENABLE_VAC_FALLBACK env.
+func SetUseVACBetaAPI(use bool) {
+	useVACBetaAPI = use
+}
+
+// getUseVACBetaAPI returns whether to use the v1beta1 VAC API.
+func getUseVACBetaAPI() bool {
+	return useVACBetaAPI
+}
+
+// getVolumeAttributesClass retrieves a VolumeAttributesClass.
+func getVolumeAttributesClass(ctx context.Context, client kubernetes.Interface, name string) (driverName string, parameters map[string]string, err error) {
+	if getUseVACBetaAPI() {
+		vac, err := client.StorageV1beta1().VolumeAttributesClasses().Get(ctx, name, metav1.GetOptions{})
+		if err != nil {
+			return "", nil, err
+		}
+		return vac.DriverName, vac.Parameters, nil
+	}
+
+	vac, err := client.StorageV1().VolumeAttributesClasses().Get(ctx, name, metav1.GetOptions{})
+	if err != nil {
+		return "", nil, err
+	}
+	return vac.DriverName, vac.Parameters, nil
+}
-- 
2.47.3

