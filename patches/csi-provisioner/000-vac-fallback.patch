From 448dd603b4975a8d4a640a5fbe66461e2f5f8510 Mon Sep 17 00:00:00 2001
From: Eddie Torres <torredil@amazon.com>
Date: Fri, 14 Nov 2025 19:27:57 +0000
Subject: [PATCH] Enable use of v1beta1 for VolumeAttributesClass API

Signed-off-by: Eddie Torres <torredil@amazon.com>
---
 cmd/csi-provisioner/csi-provisioner.go | 10 +++++++---
 pkg/controller/controller.go           |  8 ++++----
 pkg/controller/vac_compat.go           | 27 ++++++++++++++++++++++++++
 3 files changed, 38 insertions(+), 7 deletions(-)
 create mode 100644 pkg/controller/vac_compat.go

diff --git a/cmd/csi-provisioner/csi-provisioner.go b/cmd/csi-provisioner/csi-provisioner.go
index 4cb07e693..8ed347b26 100644
--- a/cmd/csi-provisioner/csi-provisioner.go
+++ b/cmd/csi-provisioner/csi-provisioner.go
@@ -211,9 +211,13 @@ func main() {
 		volumeAttributesClassV1Enabled, err := features.IsVolumeAttributesClassV1Enabled(clientset.Discovery())
 		if err == nil && !volumeAttributesClassV1Enabled {
 			if utilfeature.DefaultMutableFeatureGate.Enabled(features.VolumeAttributesClass) {
-				klog.InfoS("Disabling VolumeAttributesClass feature gate because the VolumeAttributesClass v1 API is not available")
-				if err := utilfeature.DefaultMutableFeatureGate.Set(fmt.Sprintf("%s=false", features.VolumeAttributesClass)); err != nil {
-					klog.Fatalf("Failed to disable VolumeAttributesClass feature gate: %v", err)
+				if os.Getenv("ENABLE_VAC_FALLBACK") == "true" {
+					klog.InfoS("VolumeAttributesClass v1 API not available, will use v1beta1 fallback")
+				} else {
+					klog.InfoS("Disabling VolumeAttributesClass feature gate because the VolumeAttributesClass v1 API is not available")
+					if err := utilfeature.DefaultMutableFeatureGate.Set(fmt.Sprintf("%s=false", features.VolumeAttributesClass)); err != nil {
+						klog.Fatalf("Failed to disable VolumeAttributesClass feature gate: %v", err)
+					}
 				}
 			}
 		}
diff --git a/pkg/controller/controller.go b/pkg/controller/controller.go
index 62e480bf5..dbd4da81a 100644
--- a/pkg/controller/controller.go
+++ b/pkg/controller/controller.go
@@ -768,16 +768,16 @@ func (p *csiProvisioner) prepareProvision(ctx context.Context, claim *v1.Persist
 	}
 
 	if vacName != "" {
-		vac, err := p.client.StorageV1().VolumeAttributesClasses().Get(ctx, vacName, metav1.GetOptions{})
+		driverName, parameters, err := getVolumeAttributesClass(ctx, p.client, vacName)
 		if err != nil {
 			return nil, controller.ProvisioningNoChange, err
 		}
 
-		if vac.DriverName != p.driverName {
-			return nil, controller.ProvisioningFinished, fmt.Errorf("VAC %s referenced in PVC is for driver %s which does not match driver name %s", vacName, vac.DriverName, p.driverName)
+		if driverName != p.driverName {
+			return nil, controller.ProvisioningFinished, fmt.Errorf("VAC %s referenced in PVC is for driver %s which does not match driver name %s", vacName, driverName, p.driverName)
 		}
 
-		req.MutableParameters = vac.Parameters
+		req.MutableParameters = parameters
 	}
 
 	return &prepareProvisionResult{
diff --git a/pkg/controller/vac_compat.go b/pkg/controller/vac_compat.go
new file mode 100644
index 000000000..5eeda496e
--- /dev/null
+++ b/pkg/controller/vac_compat.go
@@ -0,0 +1,27 @@
+package controller
+
+import (
+	"context"
+	"os"
+
+	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
+	"k8s.io/client-go/kubernetes"
+)
+
+// getVolumeAttributesClass retrieves a VolumeAttributesClass.
+// If ENABLE_VAC_FALLBACK is set, v1beta1 API is used, otherwise v1.
+func getVolumeAttributesClass(ctx context.Context, client kubernetes.Interface, name string) (driverName string, parameters map[string]string, err error) {
+	if os.Getenv("ENABLE_VAC_FALLBACK") == "true" {
+		vac, err := client.StorageV1beta1().VolumeAttributesClasses().Get(ctx, name, metav1.GetOptions{})
+		if err != nil {
+			return "", nil, err
+		}
+		return vac.DriverName, vac.Parameters, nil
+	}
+
+	vac, err := client.StorageV1().VolumeAttributesClasses().Get(ctx, name, metav1.GetOptions{})
+	if err != nil {
+		return "", nil, err
+	}
+	return vac.DriverName, vac.Parameters, nil
+}
-- 
2.47.3

